<h1>Electre Algorithm - Results</h1>
<div class="row">
  <div class="col-lg-4">
    <h3>Ranking</h3>
    </br>
    <table class="table table-striped" style="width: 100%;">
      <thead>
      <tr>
        <th>Rank</th>
        <th>Alternative ID</th>
        <th>Code</th>
      </tr>
      </thead>
      <tbody>
        <% @alternatives.each do |key,value| %>
          <tr>
            <td><%= value['rank'] %></td>
            <td><%= key %></td>
            <td><%= Employee.find(value['user'].to_i).code %></td>
          </tr>
        <% end %>
      </tbody>
    </table>

    </br></br>
    <h3>Sensitivity Analysis</h3>
    <% @project.criterionparams.each do |criterionparam| %>
      <strong><%= criterionparam.criterion.name.capitalize %></strong></br></br>
      <label for="inthresslo<%=criterionparam.criterion.id%>">Indifference threshold slope</label>
      <input class="tagsinput" id="inthresslo<%=criterionparam.criterion.id%>" type="text" value="
      <%=criterionparam.inthresslo ? criterionparam.inthresslo : 'none'%>,<%=criterionparam.inthresslo ? criterionparam.inthresslo : 'none'%>" data-role="tagsinput"></br></br>
      <label for="inthressint<%=criterionparam.criterion.id%>">Indifference threshold intersect</label>
      <input class="tagsinput" id="inthresint<%=criterionparam.criterion.id%>" type="text" value="
      <%=criterionparam.inthresint ? criterionparam.inthresint : 'none'%>,<%=criterionparam.inthresint ? criterionparam.inthresint : 'none'%>" data-role="tagsinput"></br></br>
      <label for="prefthresslo<%=criterionparam.criterion.id%>">Preference threshold slope</label>
      <input class="tagsinput" id="prefthresslo<%=criterionparam.criterion.id%>" type="text" value="
      <%=criterionparam.prefthresslo ? criterionparam.prefthresslo : 'none'%>, <%=criterionparam.prefthresslo ? criterionparam.prefthresslo : 'none'%>" data-role="tagsinput"></br></br>
      <label for="prefthressint<%=criterionparam.criterion.id%>">Preference threshold intersect</label>
      <input class="tagsinput" id="prefthresint<%=criterionparam.criterion.id%>" type="text" value="
      <%=criterionparam.prefthresint ? criterionparam.prefthresint : 'none'%>,<%=criterionparam.prefthresint ? criterionparam.prefthresint : 'none'%>" data-role="tagsinput"></br></br>
      <label for="vetothresslo<%=criterionparam.criterion.id%>">Veto threshold slope</label>
      <input class="tagsinput" id="vetothresslo<%=criterionparam.criterion.id%>" type="text" value="
      <%=criterionparam.vetothresslo ? criterionparam.vetothresslo : 'none'%>,<%=criterionparam.vetothresslo ? criterionparam.vetothresslo : 'none'%>" data-role="tagsinput"></br></br>
      <label for="vetothressint<%=criterionparam.criterion.id%>">Veto threshold intersect</label>
      <input class="tagsinput" id="vetothresint<%=criterionparam.criterion.id%>" type="text" value="
      <%=criterionparam.vetothresint ? criterionparam.vetothresint : 'none'%>,<%=criterionparam.vetothresint ? criterionparam.vetothresint : 'none'%>" data-role="tagsinput"></br></br></br></br>
    <% end %>
    <button class="btn btn-default">Run Sensitivity Analysis</button>
    <span class="spinner" style="display: none;"><%= image_tag('spinner.gif', width: '60') %>Running Sensitivity Analysis..</span>
    </br></br>
    <div class="alert alert-danger notEqual">Number of values are not equal for every criterion!</div>
  </div>
  <div class="col-lg-8" id="sensitivityanalysis" style="display: none;">
    <h3>Sensitivity Analysis</h3>
    </br>
    <div class="spinner" style="margin-top: 35px;">
      <div class="progress">
        <div class="progress-bar progress-bar-striped active" role="progressbar"
             aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:10%">
          10%
        </div>
      </div>
      <p>Running Sensitivity Analysis.. This could take a while..</p>
    </div>
    <div id="sensitivityresults"></div>
  </div>
  <div class="col-lg-4" id="projectparams">
    <h3>Project Parameters</h3>
    </br>
    <% @project.criterionparams.each do |criterionparam| %>
        <strong><%= criterionparam.criterion.name.capitalize %></strong><br>
        Weight: <%= criterionparam.weight %></br>
        Indifference threshold slope: <%= criterionparam.inthresslo %></br>
        Indifference threshold intersect: <%= criterionparam.inthresint %></br>
        Preference threshold slope: <%= criterionparam.prefthresslo %></br>
        Preference threshold intersect: <%= criterionparam.prefthresint %></br>
        Veto threshold slope: <%= criterionparam.vetothresslo %></br>
        Veto threshold intersect: <%= criterionparam.vetothresint %></br></br>
    <% end %>
  </div>

  <div class="col-lg-4" id="projectalternatives">
    <h3>Alternatives</h3>
    </br>
    <% @project.employees.each do |employee| %>
        <strong><%= link_to employee.code, employee_path(employee.id) %></strong></br>
        Distance: <%= Location.get_distance(employee.loclat,employee.loclon,@project.loclat,@project.loclon) %> km<br>
        <% if employee.costrate && @project.hourlyrate %>
            Margin: <%= Margin.get_margin(@project.hourlyrate,employee.costrate) %> CHF</br></br>
        <% end %>
    <% end %>
  </div>

</div>


<script>
  $('.tagsinput').tagsinput({
    allowDuplicates: true
  });

  $(".notEqual").hide();
  $("button").click(function(){
    $('.progress-bar').width("10%");
    $('.progress-bar').html("10%");
    //check whether number of params is equal in every input field (compared to first one)
    var numberIsEqual = true;
    var progress = 0;
    var finishedIterations = 0;
    var numberOfParams = $("#inthresslo<%=@project.criterionparams.first.criterion.id%>").tagsinput('items').toString().split(',').length;
    var inputdata = {};
    var outputdata = {};
    var sensitivityranking = {};
    <% @project.employees.each_with_index do |employee, index| %>
      <% hashkey = 'a' + (index+1).to_s %>
      sensitivityranking['<%= hashkey %>'] = {};
      sensitivityranking['<%= hashkey %>']['user'] = <%= employee.id %>;
      sensitivityranking['<%= hashkey %>']['score'] = 0;
    <% end %>
    
    $("#sensitivityresults").html('');
    <% @project.criterionparams.each do |criterionparam| %>
      if (!(numberOfParams == $("#inthresslo<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#inthresint<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#prefthresslo<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#prefthresint<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#vetothresslo<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#vetothresint<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      inputdata["inthresslo<%=criterionparam.criterion.id%>"] = ($("#inthresslo<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["inthresint<%=criterionparam.criterion.id%>"] = ($("#inthresint<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["prefthresslo<%=criterionparam.criterion.id%>"] = ($("#prefthresslo<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["prefthresint<%=criterionparam.criterion.id%>"] = ($("#prefthresint<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["vetothresslo<%=criterionparam.criterion.id%>"] = ($("#vetothresslo<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["vetothresint<%=criterionparam.criterion.id%>"] = ($("#vetothresint<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
    <% end %>

    if (!numberIsEqual) {
      $(".notEqual").show();
    }
    else {
      $('html,body').scrollTop(0);
      $(".notEqual").hide();
      $(".spinner").show();
      $("#projectparams").fadeOut('slow');
      $("#projectalternatives").fadeOut('slow',function(){
        $("#sensitivityanalysis").fadeIn('slow');
      });

      for (i=0;i<numberOfParams;i++){
        inputdata['iteration']=i;
        outputdata['iteration'+i] = [];
        $.ajax(
            {
              type: "POST",
              url: '/projects/1/electre-sensitivity',
              data: inputdata,
              dataType: "html",
              success: function(result) {
                finishedIterations++;

                var partialresult = JSON.parse(result);
                var partialranking =
                    '</br>' +
                    '<h4>Iteration ' + finishedIterations + '</h4>' +
                    '<table class="table table-striped table-bordered" cellspacing="0" width="100%">' +
                    '<thead>' +
                    '<tr>' +
                    '<th>Rank</th>' +
                    '<th>Alternative ID</th>' +
                    '<th>Code</th>' +
                    '</tr>' +
                    '</thead>' +
                    '<tbody>';

                Object.keys(partialresult).forEach(function (key) {
                  if (key != 'iteration') {
                    partialranking += '<tr>' +
                        '<td>' + partialresult[key]['rank'] + '</td>' +
                        '<td>' + key + '</td>' +
                        '<td>' + partialresult[key]['user'] + '</td>' +
                        '</tr>'
                  }
                });
                partialranking += '</tbody></table>';
                $("#sensitivityresults").append(partialranking);

                progress = Math.floor((finishedIterations/numberOfParams)*100);
                $('.progress-bar').width(progress + "%");
                $('.progress-bar').html(progress + "%");
                outputdata['iteration'+JSON.parse(result)['iteration']] = (JSON.parse(result));
                if (progress==100){
                  $(".spinner").fadeOut('slow');
                  console.log(outputdata);
                  Object.keys(outputdata).forEach(function (key1) {
                    iteration = outputdata[key1];
                    Object.keys(iteration).forEach(function (key2) {
                      if (sensitivityranking[key2] != undefined) {
                        sensitivityranking[key2]['score'] = Number(sensitivityranking[key2]['score']) +
                            Number(iteration[key2]['rank']);
                      }
                    });
                  });

                  var finalranking =
                    '<h4>Final Ranking</h4>' +
                    '<table class="table table-striped table-bordered data_table" cellspacing="0" width="100%">' +
                    '<thead>' +
                    '<tr>' +
                    '<th>Alternative ID</th>' +
                    '<th>User ID</th>' +
                    '<th>Score</th>' +
                    '</tr>' +
                    '</thead>' +
                    '<tbody>';

                  Object.keys(sensitivityranking).forEach(function (key) {
                    finalranking += '<tr>' +
                    '<td>' + key + '</td>' +
                    '<td>' + sensitivityranking[key]['user'] + '</td>' +
                    '<td>' + sensitivityranking[key]['score'] + '</td>' +
                    '</tr>'
                  });
                  finalranking += '</tbody></table></br>';
                  $("#sensitivityresults").html(finalranking + $("#sensitivityresults").html());
                  $('.data_table').DataTable({"order": [[ 2, "asc" ]],"info":false,"paging":false});
                }
              }
            }
        );
      }
    }
  });
</script>

<h1>Electre Algorithm - Results</h1>
<div class="row">
  <div class="col-lg-12">
    <h3>Ranking</h3>
    </br>
    <table class="table table-striped" style="width: 100%;">
      <thead>
      <tr>
        <th>Rank</th>
        <th>Alternative ID</th>
        <th>Code</th>
        <% @project.criterionparams.each do |criterionparam| %>
            <th><%= criterionparam.criterion.name %>-value (<%= criterionparam.weight %>)</th>
        <% end %>
      </tr>
      </thead>
      <tbody>
        <% @alternatives.each do |key,value| %>
          <% employee = Employee.find(value['user'].to_i) %>
          <tr>
            <td><%= value['rank'] %></td>
            <td><%= key %></td>
            <td><%= employee.code %></td>
            <% @project.criterionparams.each do |criterionparam| %>
                <% critvalue = Criterionvalue.where(:employee_id => employee.id, :criterion_id => criterionparam.criterion.id).first %>
                <td><%= critvalue ? critvalue.value : 0 %></td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="col-lg-12">
    <h3>Sensitivity Analysis</h3>
    <div id="sensitivityanalysis" style="display: none;">
      <div class="spinner" style="margin-top: 35px;">
        <div class="progress">
          <div class="progress-bar progress-bar-striped active" role="progressbar"
               aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:10%">
            10%
          </div>
        </div>
        <p>Running Sensitivity Analysis.. This could take a while..</p>
      </div>
      <div id="sensitivityresults"></div>
    </div>

    </br></br>
    <% @project.criterionparams.each do |criterionparam| %>
        <div class="col-lg-3" style="margin-left: 0; padding-left: 0;">
          <strong><%= criterionparam.criterion.name.capitalize %> (<%= criterionparam.criterion.criterioncontext.name %>)</strong></br></br>
          <label for="weight<%=criterionparam.criterion.id%>">Weight</label>
          <input class="tagsinput" id="weight<%=criterionparam.criterion.id%>" type="text" data-role="tagsinput"></br></br>
          <label for="inthresslo<%=criterionparam.criterion.id%>">Indifference threshold slope</label>
          <input class="tagsinput" id="inthresslo<%=criterionparam.criterion.id%>" type="text" data-role="tagsinput"></br></br>
          <label for="inthresint<%=criterionparam.criterion.id%>">Indifference threshold intersect</label>
          <input class="tagsinput" id="inthresint<%=criterionparam.criterion.id%>" type="text" data-role="tagsinput"></br></br>
          <label for="prefthresslo<%=criterionparam.criterion.id%>">Preference threshold slope</label>
          <input class="tagsinput" id="prefthresslo<%=criterionparam.criterion.id%>" type="text" data-role="tagsinput"></br></br>
          <label for="prefthresint<%=criterionparam.criterion.id%>">Preference threshold intersect</label>
          <input class="tagsinput" id="prefthresint<%=criterionparam.criterion.id%>" type="text" data-role="tagsinput"></br></br>
          <label for="vetothresslo<%=criterionparam.criterion.id%>">Veto threshold slope</label>
          <input class="tagsinput" id="vetothresslo<%=criterionparam.criterion.id%>" type="text" data-role="tagsinput"></br></br>
          <label for="vetothresint<%=criterionparam.criterion.id%>">Veto threshold intersect</label>
          <input class="tagsinput" id="vetothresint<%=criterionparam.criterion.id%>" type="text" data-role="tagsinput"></br></br></br></br>
      </div>
    <% end %>
    <div class="col-lg-12" style="margin: 0; padding: 0;">
      <a id="btn_duplicate_values" style="cursor: pointer;">Duplicate Values</a></br></br>
      <form action="/projects/<%= @project.id %>/save-sensitivity-params">
        <% @project.criterionparams.each do |criterionparam| %>
            <%= hidden_field_tag 'hidden_weight' + criterionparam.criterion.id.to_s %>
            <%= hidden_field_tag 'hidden_inthresslo' + criterionparam.criterion.id.to_s %>
            <%= hidden_field_tag 'hidden_inthresint' + criterionparam.criterion.id.to_s %>
            <%= hidden_field_tag 'hidden_prefthresslo' + criterionparam.criterion.id.to_s %>
            <%= hidden_field_tag 'hidden_prefthresint' + criterionparam.criterion.id.to_s %>
            <%= hidden_field_tag 'hidden_vetothresslo' + criterionparam.criterion.id.to_s %>
            <%= hidden_field_tag 'hidden_vetothresint' + criterionparam.criterion.id.to_s %>
        <% end %>
        <input type="submit" value="Save this configuration" class="btn btn-default">
      </form>


        <span id="spinner" style="display: none;"><%= image_tag('spinner.gif', width: '60') %>Looking for best candidates..</span>
        </br></br>
        <div class="alert alert-danger notEqual">Number of values are not equal for every criterion!</div>
        <div class="field form-group" style="width: 100%;">
          <label for="alpha">Distillation Alpha</label>
          <input type="text" name="alpha" value="-0.15" class="form-control" style="width: 220px;">
        </div>
        <div class="field form-group" style="width: 100%;">
          <label for="beta">Distillation Beta</label>
          <input type="text" name="beta" value="0.3" class="form-control" style="width: 220px;">
        </div>

      <button id="btn_run_analysis" class="btn btn-default">Run Analysis</button>
      <span class="spinner" style="display: none;"><%= image_tag('spinner.gif', width: '60') %>Running Sensitivity Analysis..</span>
    </div>

  </div>

</div>


<script>

    <% Sensitivity.where(:project_id => @project.id).each do |sensparam| %>
      $("#weight<%=sensparam.criterion_id%>").val(String($("#weight<%=sensparam.criterion_id%>").val()) +
          ", " + '<%= sensparam.weight.nil? ? 'none' : sensparam.weight %>');
      $("#inthresslo<%=sensparam.criterion_id%>").val($("#inthresslo<%=sensparam.criterion_id%>").val() +
        ", " + '<%= sensparam.indslo.nil? ? 'none' : sensparam.indslo %>');
      $("#inthresint<%=sensparam.criterion_id%>").val($("#inthresint<%=sensparam.criterion_id%>").val() +
        ", " + '<%= sensparam.indint.nil? ? 'none' : sensparam.indint %>');
      $("#prefthresslo<%=sensparam.criterion_id%>").val($("#prefthresslo<%=sensparam.criterion_id%>").val() +
        ", " + '<%= sensparam.prefslo.nil? ? 'none' : sensparam.prefslo %>');
      $("#prefthresint<%=sensparam.criterion_id%>").val($("#prefthresint<%=sensparam.criterion_id%>").val() +
        ", " + '<%= sensparam.prefint.nil? ? 'none' : sensparam.prefint %>');
      $("#vetothresslo<%=sensparam.criterion_id%>").val($("#vetothresslo<%=sensparam.criterion_id%>").val() +
        ", " + '<%= sensparam.vetslo.nil? ? 'none' : sensparam.vetslo %>');
      $("#vetothresint<%=sensparam.criterion_id%>").val($("#vetothresint<%=sensparam.criterion_id%>").val() +
        ", " + '<%= sensparam.vetint.nil? ? 'none' : sensparam.vetint %>');
    <% end %>
    moveItemsToHiddenFields();

  $("#btn_duplicate_values").click(function(){
    <% @project.criterionparams.each do |criterionparam| %>
      var first_value = $("#weight<%=criterionparam.criterion.id%>").tagsinput('items');
      $("#weight<%=criterionparam.criterion.id%>").tagsinput('add', first_value[0]);
      first_value= $("#inthresslo<%=criterionparam.criterion.id%>").tagsinput('items');
      $("#inthresslo<%=criterionparam.criterion.id%>").tagsinput('add', first_value[0]);
      first_value = $("#inthresint<%=criterionparam.criterion.id%>").tagsinput('items');
      $("#inthresint<%=criterionparam.criterion.id%>").tagsinput('add', first_value[0]);
      first_value = $("#prefthresslo<%=criterionparam.criterion.id%>").tagsinput('items');
      $("#prefthresslo<%=criterionparam.criterion.id%>").tagsinput('add', first_value[0]);
      first_value = $("#prefthresint<%=criterionparam.criterion.id%>").tagsinput('items');
      $("#prefthresint<%=criterionparam.criterion.id%>").tagsinput('add', first_value[0]);
      first_value = $("#vetothresslo<%=criterionparam.criterion.id%>").tagsinput('items');
      $("#vetothresslo<%=criterionparam.criterion.id%>").tagsinput('add', first_value[0]);
      first_value = $("#vetothresint<%=criterionparam.criterion.id%>").tagsinput('items');
      $("#vetothresint<%=criterionparam.criterion.id%>").tagsinput('add', first_value[0]);
    <% end %>
  });
  $('.tagsinput').tagsinput({
    allowDuplicates: true,
    onAddTag: function(){alert("lukas")}
  });
  $('.tagsinput').on('itemAdded', function(event) {
    moveItemsToHiddenFields();
  });

  function moveItemsToHiddenFields() {
    <% @project.criterionparams.each do |criterionparam| %>
      $("#hidden_weight<%=criterionparam.criterion.id%>").val($("#weight<%=criterionparam.criterion.id%>").val());
      $("#hidden_inthresslo<%=criterionparam.criterion.id%>").val($("#inthresslo<%=criterionparam.criterion.id%>").val());
      $("#hidden_inthresint<%=criterionparam.criterion.id%>").val($("#inthresint<%=criterionparam.criterion.id%>").val());
      $("#hidden_prefthresslo<%=criterionparam.criterion.id%>").val($("#prefthresslo<%=criterionparam.criterion.id%>").val());
      $("#hidden_prefthresint<%=criterionparam.criterion.id%>").val($("#prefthresint<%=criterionparam.criterion.id%>").val());
      $("#hidden_vetothresslo<%=criterionparam.criterion.id%>").val($("#vetothresslo<%=criterionparam.criterion.id%>").val());
      $("#hidden_vetothresint<%=criterionparam.criterion.id%>").val($("#vetothresint<%=criterionparam.criterion.id%>").val());
    <% end %>
  }

  $(".notEqual").hide();
  $("#btn_run_analysis").click(function(){
    $('.progress-bar').width("10%");
    $('.progress-bar').html("10%");
    //check whether number of params is equal in every input field (compared to first one)
    var numberIsEqual = true;
    var progress = 0;
    var finishedIterations = 0;
    var numberOfParams = $("#inthresslo<%=@project.criterionparams.first.criterion.id%>").tagsinput('items').toString().split(',').length;
    var inputdata = {};
    var outputdata = {};
    var sensitivityranking = {};

    <% @project.employees.each_with_index do |employee, index| %>
      <% hashkey = 'a' + (index+1).to_s %>
      sensitivityranking['<%= hashkey %>'] = {};
      sensitivityranking['<%= hashkey %>']['user'] = '<%= employee.code %>';
      sensitivityranking['<%= hashkey %>']['score'] = 0;
    <% end %>
    
    $("#sensitivityresults").html('');
    <% @project.criterionparams.each do |criterionparam| %>
      if (!(numberOfParams == $("#weight<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#inthresslo<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#inthresint<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#prefthresslo<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#prefthresint<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#vetothresslo<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      if (!(numberOfParams == $("#vetothresint<%=criterionparam.criterion.id%>").tagsinput('items').toString().split(',').length)) {
        numberIsEqual = false;
      }
      inputdata["weight<%=criterionparam.criterion.id%>"] = ($("#weight<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["inthresslo<%=criterionparam.criterion.id%>"] = ($("#inthresslo<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["inthresint<%=criterionparam.criterion.id%>"] = ($("#inthresint<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["prefthresslo<%=criterionparam.criterion.id%>"] = ($("#prefthresslo<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["prefthresint<%=criterionparam.criterion.id%>"] = ($("#prefthresint<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["vetothresslo<%=criterionparam.criterion.id%>"] = ($("#vetothresslo<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
      inputdata["vetothresint<%=criterionparam.criterion.id%>"] = ($("#vetothresint<%=criterionparam.criterion.id%>"))
          .tagsinput('items').toString().split(',').map(function(item) { return Number(item); });
    <% end %>

    if (!numberIsEqual) {
      $(".notEqual").show();
    }
    else {
      $('html,body').scrollTop(0);
      $(".notEqual").hide();
      $(".spinner").show();
      $("#sensitivityanalysis").fadeIn('slow');

      for (i=0;i<numberOfParams;i++){
        inputdata['iteration']=i;
        outputdata['iteration'+i] = [];
        $.ajax(
            {
              type: "POST",
              url: '/projects/<%= @project.id %>/electre-sensitivity',
              data: inputdata,
              dataType: "html",
              success: function(result) {
                finishedIterations++;

                var partialresult = JSON.parse(result);
                var partialranking =
                    '</br>' +
                    '<h4>Iteration ' + finishedIterations + '</h4>' +
                    '<table class="table table-striped table-bordered" cellspacing="0" width="100%">' +
                    '<thead>' +
                    '<tr>' +
                    '<th>Rank</th>' +
                    '<th>Alternative ID</th>' +
                    '<th>Code</th>' +
                    '</tr>' +
                    '</thead>' +
                    '<tbody>';

                Object.keys(partialresult).forEach(function (key) {
                  if (key != 'iteration') {
                    partialranking += '<tr>' +
                        '<td>' + partialresult[key]['rank'] + '</td>' +
                        '<td>' + key + '</td>' +
                        '<td>' + partialresult[key]['user'] + '</td>' +
                        '</tr>'
                  }
                });
                partialranking += '</tbody></table>';
                $("#sensitivityresults").append(partialranking);

                progress = Math.floor((finishedIterations/numberOfParams)*100);
                $('.progress-bar').width(progress + "%");
                $('.progress-bar').html(progress + "%");
                outputdata['iteration'+JSON.parse(result)['iteration']] = (JSON.parse(result));
                if (progress==100){
                  $(".spinner").fadeOut('slow');
                  Object.keys(outputdata).forEach(function (key1) {
                    iteration = outputdata[key1];
                    Object.keys(iteration).forEach(function (key2) {
                      if (sensitivityranking[key2] != undefined) {
                        sensitivityranking[key2]['score'] = Number(sensitivityranking[key2]['score']) +
                            Number(iteration[key2]['rank']);
                      }
                    });
                  });

                  var finalranking =
                    '<h4>Final Ranking</h4>' +
                    '<table class="table table-striped table-bordered data_table" cellspacing="0" width="100%">' +
                    '<thead>' +
                    '<tr>' +
                    '<th>Alternative ID</th>' +
                    '<th>Alternative code</th>' +
                    '<th>Score</th>' +
                    '</tr>' +
                    '</thead>' +
                    '<tbody>';

                  Object.keys(sensitivityranking).forEach(function (key) {
                    finalranking += '<tr>' +
                    '<td>' + key + '</td>' +
                    '<td>' + sensitivityranking[key]['user'] + '</td>' +
                    '<td>' + sensitivityranking[key]['score'] + '</td>' +
                    '</tr>'
                  });
                  finalranking += '</tbody></table></br>';
                  $("#sensitivityresults").html(finalranking + $("#sensitivityresults").html());
                  $('.data_table').DataTable({"order": [[ 2, "asc" ]],"info":false,"paging":false});
                }
              }
            }
        );
      }
    }
  });
</script>
